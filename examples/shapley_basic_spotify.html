<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="KNN Shapley" href="shapley_knn_flowers.html" /><link rel="prev" title="Examples" href="index.html" />

    <!-- Generated with Sphinx 5.3.0 and Furo 2023.03.27 -->
        <title>Shapley for data valuation - pyDVL 0.6.2.dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../_static/css/tooltipster.custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/tooltipster.bundle.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/tooltipster-sideTip-shadow.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/tooltipster-sideTip-punk.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/tooltipster-sideTip-noir.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/tooltipster-sideTip-light.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/tooltipster-sideTip-borderless.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/micromodal.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<div class="announcement">
  <aside class="announcement-content">
     pyDVL is in an early stage of development. Expect changes to functionality and the API until version 1.0.0. 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">pyDVL 0.6.2.dev0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.svg" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../10-getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../20-install.html">Installing pyDVL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../30-data-valuation.html">Computing data values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../40-influence.html">Computing influence values</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Examples</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Shapley for data valuation</a></li>
<li class="toctree-l2"><a class="reference internal" href="shapley_knn_flowers.html">KNN Shapley</a></li>
<li class="toctree-l2"><a class="reference internal" href="shapley_utility_learning.html">Data Utility Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="least_core_basic.html">Least Core for Data Valuation</a></li>
<li class="toctree-l2"><a class="reference internal" href="influence_imagenet.html">Influence functions for image classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="influence_synthetic.html">Influence functions for data mislabeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="influence_wine.html">Influence functions for outlier detection</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../pydvl/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pydvl/influence.html">influence</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/influence/general.html">general</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/influence/inversion.html">inversion</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pydvl/influence/torch.html">torch</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/influence/torch/functional.html">functional</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/influence/torch/torch_differentiable.html">torch_differentiable</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/influence/torch/util.html">util</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/influence/twice_differentiable.html">twice_differentiable</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pydvl/reporting.html">reporting</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/reporting/plots.html">plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/reporting/scores.html">scores</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pydvl/utils.html">utils</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/utils/caching.html">caching</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/utils/config.html">config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/utils/dataset.html">dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/utils/numeric.html">numeric</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pydvl/utils/parallel.html">parallel</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/utils/parallel/backend.html">backend</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../pydvl/utils/parallel/futures.html">futures</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../pydvl/utils/parallel/futures/ray.html">ray</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/utils/parallel/map_reduce.html">map_reduce</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/utils/progress.html">progress</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/utils/score.html">score</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/utils/status.html">status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/utils/types.html">types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/utils/utility.html">utility</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pydvl/value.html">value</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pydvl/value/least_core.html">least_core</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/least_core/common.html">common</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/least_core/montecarlo.html">montecarlo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/least_core/naive.html">naive</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pydvl/value/loo.html">loo</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/loo/naive.html">naive</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/value/result.html">result</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/value/sampler.html">sampler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/value/semivalues.html">semivalues</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pydvl/value/shapley.html">shapley</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/shapley/common.html">common</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/shapley/gt.html">gt</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/shapley/knn.html">knn</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/shapley/montecarlo.html">montecarlo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/shapley/naive.html">naive</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/shapley/owen.html">owen</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/shapley/truncated.html">truncated</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pydvl/value/shapley/types.html">types</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../pydvl/value/stopping.html">stopping</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="admonition note">
    This page was generated from
    <a class="reference external" href="https://github.com/appliedAI-Initiative/pyDVL/blob/develop/notebooks/shapley_basic_spotify.ipynb">notebooks/shapley_basic_spotify.ipynb</a>
    <br>
    Interactive online version:
    <span style="white-space: nowrap;">
        <a href="https://mybinder.org/v2/gh/appliedAI-Initiative/pyDVL/develop?filepath=notebooks/shapley_basic_spotify.ipynb">
            <img alt="Binder badge" src="https://mybinder.org/badge_logo.svg" style="vertical-align:text-bottom">
        </a>
    </span>
</div>

<style>
    .nbinput .prompt,
    .nboutput .prompt {
        display: none;
    }
    @media not print {
        [data-theme='dark'] .output_area img {
            filter: invert(0.9);
        }
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) .output_area img {
                filter: invert(0.9);
            }
        }
    }
</style><section id="Shapley-for-data-valuation">
<h1>Shapley for data valuation<a class="headerlink" href="#Shapley-for-data-valuation" title="Permalink to this heading">#</a></h1>
<p>This notebook introduces Shapley methods for the computation of data value using pyDVL.</p>
<p>In order to illustrate the practical advantages, we will predict the popularity of songs in the dataset <a class="reference external" href="https://www.kaggle.com/datasets/paradisejoy/top-hits-spotify-from-20002019">Top Hits Spotify from 2000-2019</a>, and highlight how data valuation can help investigate and boost the performance of the models. In doing so, we will describe the basic usage patterns of pyDVL.</p>
<p>Recall that data value is a function of three things:</p>
<ol class="arabic simple">
<li><p>The dataset.</p></li>
<li><p>The model.</p></li>
<li><p>The performance metric or scoring function.</p></li>
</ol>
<p>Below we will describe how to instantiate each one of these objects and how to use them for data valuation. Please also see the <a class="reference internal" href="../30-data-valuation.html"><span class="doc">documentation on data valuation</span></a>.</p>
<section id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this heading">#</a></h2>
<p>We begin by importing the main libraries and setting some defaults.</p>
<div class="admonition note">
<p>If you are reading this in the documentation, some boilerplate has been omitted for convenience.</p>
</div>
<p>We will be using the following functions from pyDVL. The main entry point is the function <a class="reference internal" href="../pydvl/value/shapley/common.html#pydvl.value.shapley.common.compute_shapley_values"><span class="std std-ref">compute_shapley_values()</span></a>, which provides a facade to all Shapley methods. In order to use it we need the classes <a class="reference internal" href="../pydvl/utils/dataset.html#pydvl.utils.dataset.Dataset"><span class="std std-ref">Dataset</span></a>, <a class="reference internal" href="../pydvl/utils/utility.html#pydvl.utils.utility.Utility"><span class="std std-ref">Utility</span></a> and <a class="reference internal" href="../pydvl/utils/score.html#pydvl.utils.score.Scorer"><span class="std std-ref">Scorer</span></a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">autoreload</span>
<span class="kn">from</span> <span class="nn">pydvl.reporting.plots</span> <span class="kn">import</span> <span class="n">plot_shapley</span>
<span class="kn">from</span> <span class="nn">pydvl.utils.dataset</span> <span class="kn">import</span> <span class="n">GroupedDataset</span>
<span class="kn">from</span> <span class="nn">support.shapley</span> <span class="kn">import</span> <span class="n">load_spotify_dataset</span>
<span class="kn">from</span> <span class="nn">pydvl.value</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
</section>
<section id="Loading-and-grouping-the-dataset">
<h2>Loading and grouping the dataset<a class="headerlink" href="#Loading-and-grouping-the-dataset" title="Permalink to this heading">#</a></h2>
<p>pyDVL provides a support function for this notebook, <code class="docutils literal notranslate"><span class="pre">load_spotify_dataset()</span></code>, which downloads data on songs published after 2014, and splits 30% of data for testing, and 30% of the remaining data for validation. The return value is a triple of training, validation and test data as lists of the form <code class="docutils literal notranslate"><span class="pre">[X_input,</span> <span class="pre">Y_label]</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training_data</span><span class="p">,</span> <span class="n">val_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">load_spotify_dataset</span><span class="p">(</span>
    <span class="n">val_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">target_column</span><span class="o">=</span><span class="s2">&quot;popularity&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>artist</th>
      <th>song</th>
      <th>duration_ms</th>
      <th>explicit</th>
      <th>year</th>
      <th>danceability</th>
      <th>energy</th>
      <th>key</th>
      <th>loudness</th>
      <th>mode</th>
      <th>speechiness</th>
      <th>acousticness</th>
      <th>instrumentalness</th>
      <th>liveness</th>
      <th>valence</th>
      <th>tempo</th>
      <th>genre</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1561</th>
      <td>Fetty Wap</td>
      <td>679 (feat. Remy Boyz)</td>
      <td>196693</td>
      <td>True</td>
      <td>2015</td>
      <td>0.618</td>
      <td>0.717</td>
      <td>7</td>
      <td>-5.738</td>
      <td>1</td>
      <td>0.3180</td>
      <td>0.00256</td>
      <td>0.000000</td>
      <td>0.6250</td>
      <td>0.603</td>
      <td>190.050</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1410</th>
      <td>Meghan Trainor</td>
      <td>All About That Bass</td>
      <td>187920</td>
      <td>True</td>
      <td>2015</td>
      <td>0.807</td>
      <td>0.887</td>
      <td>9</td>
      <td>-3.726</td>
      <td>1</td>
      <td>0.0503</td>
      <td>0.05730</td>
      <td>0.000003</td>
      <td>0.1240</td>
      <td>0.961</td>
      <td>134.052</td>
      <td>14</td>
    </tr>
    <tr>
      <th>1772</th>
      <td>Katy Perry</td>
      <td>Chained To The Rhythm</td>
      <td>237733</td>
      <td>False</td>
      <td>2017</td>
      <td>0.562</td>
      <td>0.800</td>
      <td>0</td>
      <td>-5.404</td>
      <td>1</td>
      <td>0.1120</td>
      <td>0.08140</td>
      <td>0.000000</td>
      <td>0.1990</td>
      <td>0.471</td>
      <td>95.029</td>
      <td>14</td>
    </tr>
    <tr>
      <th>1670</th>
      <td>Sigala</td>
      <td>Sweet Lovin' - Radio Edit</td>
      <td>202149</td>
      <td>False</td>
      <td>2015</td>
      <td>0.683</td>
      <td>0.910</td>
      <td>10</td>
      <td>-1.231</td>
      <td>1</td>
      <td>0.0515</td>
      <td>0.05530</td>
      <td>0.000005</td>
      <td>0.3360</td>
      <td>0.674</td>
      <td>124.977</td>
      <td>15</td>
    </tr>
    <tr>
      <th>1780</th>
      <td>Liam Payne</td>
      <td>Strip That Down</td>
      <td>204502</td>
      <td>False</td>
      <td>2017</td>
      <td>0.869</td>
      <td>0.485</td>
      <td>6</td>
      <td>-5.595</td>
      <td>1</td>
      <td>0.0545</td>
      <td>0.24600</td>
      <td>0.000000</td>
      <td>0.0765</td>
      <td>0.527</td>
      <td>106.028</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The dataset has many high-level features, some quite intuitive (‘duration_ms’ or ‘tempo’), while others are a bit more cryptic (‘valence’?). For information on each feature, please consult <a class="reference external" href="https://www.kaggle.com/datasets/paradisejoy/top-hits-spotify-from-20002019">the dataset’s website</a>.</p>
<p>In our analysis, we will use all the columns, except for ‘artist’ and ‘song’, to predict the ‘popularity’ of each song. We will nonetheless keep the information on song and artist in a separate object for future reference.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">song_name</span> <span class="o">=</span> <span class="n">training_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;song&quot;</span><span class="p">]</span>
<span class="n">artist</span> <span class="o">=</span> <span class="n">training_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;artist&quot;</span><span class="p">]</span>
<span class="n">training_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">training_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;song&quot;</span><span class="p">,</span> <span class="s2">&quot;artist&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;song&quot;</span><span class="p">,</span> <span class="s2">&quot;artist&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">val_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;song&quot;</span><span class="p">,</span> <span class="s2">&quot;artist&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Input and label data are then used to instantiate a <a class="reference internal" href="../pydvl/utils/dataset.html#pydvl.utils.dataset.Dataset"><span class="std std-ref">Dataset</span></a> object:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="o">*</span><span class="n">training_data</span><span class="p">,</span> <span class="o">*</span><span class="n">val_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The calculation of exact Shapley values is computationally very expensive (exponentially so!) because it requires training the model on every possible subset of the training set. For this reason, PyDVL implements techniques to speed up the calculation, such as <a class="reference internal" href="../pydvl/value/shapley/montecarlo.html"><span class="doc">Monte Carlo approximations</span></a>, <a class="reference internal" href="../pydvl/utils/utility.html#pydvl.utils.utility.DataUtilityLearning"><span class="std std-ref">surrogate models</span></a> or <a class="reference internal" href="../pydvl/utils/caching.html"><span class="doc">caching</span></a> of intermediate results and
grouping of data to calculate group Shapley values instead of single data points.</p>
<p>In our case, we will group songs by artist and calculate the Shapley value for the artists. Given the <a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.Series.html">pandas Series</a> for ‘artist’, to group the dataset by it, one does the following:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped_dataset</span> <span class="o">=</span> <span class="n">GroupedDataset</span><span class="o">.</span><span class="n">from_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">data_groups</span><span class="o">=</span><span class="n">artist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Creating-the-utility-and-computing-values">
<h2>Creating the utility and computing values<a class="headerlink" href="#Creating-the-utility-and-computing-values" title="Permalink to this heading">#</a></h2>
<p>Now we can calculate the contribution of each group to the model performance.</p>
<p>As a model, we use scikit-learn’s <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.GradientBoostingRegressor.html">GradientBoostingRegressor</a>, but pyDVL can work with any model from sklearn, xgboost or lightgbm. More precisely, any model that implements the protocol <a class="reference internal" href="../pydvl/utils/types.html#pydvl.utils.types.SupervisedModel"><span class="std std-ref">pydvl.utils.types.SupervisedModel</span></a>, which is just the standard sklearn interface of <code class="docutils literal notranslate"><span class="pre">fit()</span></code>,<code class="docutils literal notranslate"><span class="pre">predict()</span></code> and <code class="docutils literal notranslate"><span class="pre">score()</span></code> can be used to
construct the utility.</p>
<p>The third and final component is the scoring function. It can be anything like accuracy or <span class="math notranslate nohighlight">\(R^2\)</span>, and is set with a string from the <a class="reference external" href="https://scikit-learn.org/stable/modules/model_evaluation.html">standard sklearn scoring methods</a>. Please refer to that documentation on information on how to define your own scoring function.</p>
<p>We group dataset, model and scoring function into an instance of <a class="reference internal" href="../pydvl/utils/utility.html#pydvl.utils.utility.Utility"><span class="std std-ref">Utility</span></a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utility</span> <span class="o">=</span> <span class="n">Utility</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">data</span><span class="o">=</span><span class="n">grouped_dataset</span><span class="p">,</span>
    <span class="n">scorer</span><span class="o">=</span><span class="n">Scorer</span><span class="p">(</span><span class="s2">&quot;neg_mean_absolute_error&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">compute_shapley_values</span><span class="p">(</span>
    <span class="n">utility</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="n">ShapleyMode</span><span class="o">.</span><span class="n">TruncatedMontecarlo</span><span class="p">,</span>
    <span class="c1"># Stop if the standard error is below 1% of the range of the values (which is ~2),</span>
    <span class="c1"># or if the number of updates exceeds 1000</span>
    <span class="n">done</span><span class="o">=</span><span class="n">AbsoluteStandardError</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span> <span class="o">|</span> <span class="n">MaxUpdates</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;data_value&quot;</span><span class="p">,</span> <span class="n">use_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The function <a class="reference internal" href="../pydvl/value/shapley/common.html#pydvl.value.shapley.common.compute_shapley_values"><span class="std std-ref">compute_shapley_values()</span></a> serves as a common access point to all Shapley methods. For several of them, we choose a <code class="docutils literal notranslate"><span class="pre">StoppingCriterion</span></code> with the argument <code class="docutils literal notranslate"><span class="pre">done=</span></code>. In this case we choose to stop when the ratio of standard error to value is below 0.3 for at least 90% of the training points, or if the number of updates of any index exceeds 200. The <code class="docutils literal notranslate"><span class="pre">mode</span></code> argument specifies the Shapley method
to use. In this case, we use the <a class="reference internal" href="../pydvl/value/shapley/truncated.html#pydvl.value.shapley.truncated.truncated_montecarlo_shapley"><span class="std std-ref">Truncated Monte Carlo approximation</span></a>, which is the fastest of the Monte Carlo methods.</p>
<p>Let’s take a look at the returned dataframe:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>data_value</th>
      <th>data_value_stderr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Kendrick Lamar</th>
      <td>-1.279149</td>
      <td>0.091670</td>
    </tr>
    <tr>
      <th>BLACKPINK</th>
      <td>-1.277363</td>
      <td>0.177476</td>
    </tr>
    <tr>
      <th>Adele</th>
      <td>-1.241698</td>
      <td>0.183732</td>
    </tr>
    <tr>
      <th>5 Seconds of Summer</th>
      <td>-1.228002</td>
      <td>0.103377</td>
    </tr>
    <tr>
      <th>Flume</th>
      <td>-1.197065</td>
      <td>0.102345</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The first thing to notice is that we sorted the results in ascending order of Shapley value. The index holds the labels for each data group: in this case, artist names. The column <code class="docutils literal notranslate"><span class="pre">data_value</span></code> is just that: the Shapley Data value, and <code class="docutils literal notranslate"><span class="pre">data_value_stderr</span></code> is its estimated standard error because we are using a Monte Carlo approximation.</p>
<p>Let us plot the results. In the next cell we will take the 30 artists with the lowest score and plot their values with 95% Normal confidence intervals. Keep in mind that Monte Carlo Shapley is typically very noisy, and it can take many steps to arrive at a clean estimate.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_shapley_basic_spotify_24_0.png" src="../_images/examples_shapley_basic_spotify_24_0.png" />
</div>
</div>
<p>We can immediately see that many artists (groups of samples) have very low, even negative value, which means that they tend to decrease the total score of the model when present in the training set! What happens if we remove them?</p>
<p>In the next cell we create a new training set excluding the artists with the lowest scores:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">low_dvl_artists</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">artist_filter</span> <span class="o">=</span> <span class="o">~</span><span class="n">artist</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">low_dvl_artists</span><span class="p">)</span>
<span class="n">X_train_good_dvl</span> <span class="o">=</span> <span class="n">training_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">artist_filter</span><span class="p">]</span>
<span class="n">y_train_good_dvl</span> <span class="o">=</span> <span class="n">training_data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">artist_filter</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now we will use this “cleaned” dataset to retrain the same model and compare its mean absolute error to the one trained on the full dataset. Notice that the score now is calculated using the test set, while in the calculation of the Shapley values we were using the validation set.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_good_data</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train_good_dvl</span><span class="p">,</span> <span class="n">y_train_good_dvl</span>
<span class="p">)</span>
<span class="n">error_good_data</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span>
    <span class="n">model_good_data</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">test_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">model_all_data</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">training_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">training_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">error_all_data</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">model_all_data</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">test_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Improvement: </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">error_all_data</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">error_good_data</span><span class="p">)</span><span class="o">/</span><span class="n">error_all_data</span><span class="si">:</span><span class="s2">02f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Improvement: 13.940685%
</pre></div></div>
</div>
<p>The score has improved by almost 14%! This is quite an important result, as it shows a consistent process to improve the performance of a model by excluding data points from its training set.</p>
<div class="admonition warning">
<p>One must however proceed with caution instead of simply throwing away data. For one, <code class="docutils literal notranslate"><span class="pre">mean_absolute_error</span></code> is an estimate of generalization error on unseen data, so the improvement we see on the test set might not be as large upon deployment. It would be advisable to cross-validate this whole process to obtain more conservative estimates. It is also advisable to manually inspect the artists with low value and to try to understand the reason why the model behaves like it does. Finally, remember
that <strong>the value depends on the model chosen</strong>! Artists that are detrimental to the Gradient Boosting Regressor might be informative for a different model (although it is likely that the worst ones share some characteristic making them “bad” for other regressors).</p>
</div>
</section>
<section id="Evaluation-on-anomalous-data">
<h2>Evaluation on anomalous data<a class="headerlink" href="#Evaluation-on-anomalous-data" title="Permalink to this heading">#</a></h2>
<p>One interesting test is to corrupt some data and to monitor how their value changes. To do this, we will take one of the artists with the highest value and set the popularity of all their songs to 0.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_shapley_basic_spotify_33_0.png" src="../_images/examples_shapley_basic_spotify_33_0.png" />
</div>
</div>
<p>Let us take all the songs by Rihanna, set their score to 0 and re-calculate the Shapley values.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train_anomalous</span> <span class="o">=</span> <span class="n">training_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">y_train_anomalous</span><span class="p">[</span><span class="n">artist</span> <span class="o">==</span> <span class="s2">&quot;Rihanna&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">anomalous_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
    <span class="n">x_train</span><span class="o">=</span><span class="n">training_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">y_train</span><span class="o">=</span><span class="n">y_train_anomalous</span><span class="p">,</span>
    <span class="n">x_test</span><span class="o">=</span><span class="n">val_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">y_test</span><span class="o">=</span><span class="n">val_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">grouped_anomalous_dataset</span> <span class="o">=</span> <span class="n">GroupedDataset</span><span class="o">.</span><span class="n">from_dataset</span><span class="p">(</span><span class="n">anomalous_dataset</span><span class="p">,</span> <span class="n">artist</span><span class="p">)</span>
<span class="n">anomalous_utility</span> <span class="o">=</span> <span class="n">Utility</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">data</span><span class="o">=</span><span class="n">grouped_anomalous_dataset</span><span class="p">,</span>
    <span class="n">scorer</span><span class="o">=</span><span class="n">Scorer</span><span class="p">(</span><span class="s2">&quot;neg_mean_absolute_error&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">compute_shapley_values</span><span class="p">(</span>
    <span class="n">anomalous_utility</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="n">ShapleyMode</span><span class="o">.</span><span class="n">TruncatedMontecarlo</span><span class="p">,</span>
    <span class="n">done</span><span class="o">=</span><span class="n">AbsoluteStandardError</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span> <span class="o">|</span> <span class="n">MaxUpdates</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;data_value&quot;</span><span class="p">,</span> <span class="n">use_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let us now consider the low-value artists (at least for predictive purposes, no claims are made about their artistic value!) and plot the results</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_shapley_basic_spotify_38_0.png" src="../_images/examples_shapley_basic_spotify_38_0.png" />
</div>
</div>
<p>And Rihanna (our anomalous data group) has moved from top contributor to having negative impact on the performance of the model, as expected!</p>
<p>What is going on? A popularity of 0 for Rihanna’s songs is inconsistent with listening patterns for other artists. In artificially setting this, we degrade the predictive power of the model.</p>
<p>By dropping low-value groups or samples, one can often increase model performance, but by <em>inspecting</em> them, it is possible to identify bogus data sources or acquisition methods.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="shapley_knn_flowers.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">KNN Shapley</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Examples</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; AppliedAI Institute gGmbH
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/appliedAI-Initiative/pyDVL" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Shapley for data valuation</a><ul>
<li><a class="reference internal" href="#Setup">Setup</a></li>
<li><a class="reference internal" href="#Loading-and-grouping-the-dataset">Loading and grouping the dataset</a></li>
<li><a class="reference internal" href="#Creating-the-utility-and-computing-values">Creating the utility and computing values</a></li>
<li><a class="reference internal" href="#Evaluation-on-anomalous-data">Evaluation on anomalous data</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/js/hoverxref.js"></script>
    <script src="../_static/js/tooltipster.bundle.min.js"></script>
    <script src="../_static/js/micromodal.min.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["\\(", "\\)"]], "processEscapes": true, "displayMath": [["\\[", "\\]"]]}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>